# Instructions to recreate and preprocess the MIMIC-III sepsis cohort

MIMIC-III is a publicly accessible clinical database. We (the authors) are not the owners of the data and, therefore, we do not include them in the current repository. However, to facilitate research on the topic, we include a step-by-step guide that explains how to use the MIMIC-III database in conjunction with publicly available code to replicate the dataset we used in our experiments. The guide is intended for users working with MIMIC-III v1.4, a UNIX-based system and the PostgreSQL Database Management System. Relevant guidelines for users with different setups can be found in the links provided below. The high-level steps (which we subsequently explain in more detail) are:
1. Set up the MIMIC-III database using PostgreSQL
1. Use the code of [Komorowski et al.](https://www.nature.com/articles/s41591-018-0213-5) to identify the sepsis cohort (*note*: part of the code is written in MATLAB)
1. Use our code to create the final csv files

## 1. Set up the MIMIC-III database using PostgreSQL

1. Accessing the data requires a short training on aspects related to research with human participant data. To get access to the data, read the related instructions on the [Physionet website](https://physionet.org/content/mimiciii/1.4/). Next, download the folder containing the MIMIC-III files (named `physionet.org/`) and place it inside the current directory (`data/mimic-rebuild/`).
1. Install the PostgreSQL Database Management System. In Mac OS, you can simply use [Homebrew](https://brew.sh/) and `brew install postgresql`.
1. Download the files from https://github.com/MIT-LCP/mimic-code/tree/main/mimic-iii/buildmimic/postgres and place them directly into the current directory (`data/mimic-rebuild/`).
1. Follow the Physionet instructions in https://mimic.mit.edu/docs/gettingstarted/local/install-mimic-locally-ubuntu/ to set up the MIMIC-III database using PostgreSQL. Things to note:
    * In step 3, let the username be ''mimicuser''
    * In step 8, make sure to set `mimic_data_dir` to the directory that contains the downloaded MIMIC-III files and to use the correct SQL file depending on whether the data are compressed. Example command for GZ files: `psql 'dbname=mimic user=mimicuser options=--search_path=mimiciii' -f postgres_load_data_gz.sql -v mimic_data_dir=physionet.org/files/mimiciii/1.4/`
1. Download the Elixhauser comorbidity SQL script from https://github.com/MIT-LCP/mimic-code/blob/main/mimic-iii/concepts_postgres/comorbidity/elixhauser_quan.sql and run it (`psql 'dbname=mimic user=mimicuser options=--search_path=mimiciii' -f elixhauser_quan.sql`)

## 2. Use the code of [Komorowski et al.](https://www.nature.com/articles/s41591-018-0213-5) to identify the sepsis cohort

1. Clone the paper's [code repository](https://github.com/matthieukomorowski/AI_Clinician) inside the current directory (`data/mimic-rebuild/`).
1. Inside the downloaded `AI_Clinician` directory, create a new directory called `exportdir`.
1. Open and run the notebook `AIClinician_Data_extract_MIMIC3_140219.ipynb`. Things to note:
    * In the initial cell, where the connection to the database takes place, use the following code:
        ```python
        # Update connection details to MIMIC-III
        conn = psycopg2.connect("dbname=mimic user=mimicuser options=--search_path=mimiciii")

        # Update the path for data extraction here
        exportdir='exportdir/'
        ```
    * In section "Demographics", in the given `query`, replace `public.elixhauser_quan` with `mimiciii.elixhauser_quan`
1. Run the MATLAB script `AIClinician_sepsis3_def_160219.m`. Things to note:
    * Before running the script, make sure to load the required matrices from `refernce_matrices.mat`
    * In the initial block (`% IMPORT ALL DATA %`), set the initial file paths correctly (remove the prefix `D:/`)
    * The script may run for a long time (1-2 hours)
1. Run the MATLAB script `AIClinician_mimic3_dataset_160219.m`. Things to note:
    * Fix the path in line 362 by deleting `D:\BACKUP MIT PC\`
    * Fix the path in line 518 by deleting `D:\BACKUP MIT PC\`
    * The script holds the final dataset in a matrix called `MIMICtable` but it does not save it to a file. At the end of the script, add and execute the command `writetable(MIMICtable,'mimic-table.csv','Delimiter',',');`.
    * The script may run for a long time (1-2 hours)

## 3. Use our code to create the final csv files

1. Place the file `mimic-table.csv` generated by the MATLAB code directly under the directory `data/mimic-rebuild/`
1. Execute the bash script `scripts/build_datasets.sh`
1. Find the final csv files located in the directory `data/processed/`